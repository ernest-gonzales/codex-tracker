name: Release

on:
  push:
    tags:
      - "v*"

# Default: no broad permissions. We'll grant per-job.
permissions: {}

jobs:
  build-macos:
    runs-on: macos-14
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo bin (tauri-cli)
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-bin-tauri-cli-2.5.0

      - name: Install Tauri CLI
        run: |
          TAURI_CLI_VERSION="2.5.0"
          if command -v cargo-tauri >/dev/null 2>&1; then
            if cargo tauri --version 2>/dev/null | grep -q "${TAURI_CLI_VERSION}"; then
              exit 0
            fi
          fi
          cargo install tauri-cli --locked --version "${TAURI_CLI_VERSION}"

      - name: Install web deps
        working-directory: apps/web
        run: npm ci

      - name: Build web
        working-directory: apps/web
        run: npm run build

      - name: Build Tauri bundles
        working-directory: apps/desktop/src-tauri
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Build CLI
        run: cargo build -p codex_tracker_cli --release --target ${{ matrix.target }}

      - name: Collect artifacts
        id: artifacts
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          TARGET_DIR="$(cargo metadata --manifest-path apps/desktop/src-tauri/Cargo.toml --format-version 1 --no-deps | python3 -c 'import json,sys; print(json.load(sys.stdin)["target_directory"])')"
          BUNDLE_DIR="${TARGET_DIR}/${{ matrix.target }}/release/bundle"
          APP_PATH="$(find "${BUNDLE_DIR}" -type d -name "*.app" -print -quit)"
          DMG_PATH="$(find "${BUNDLE_DIR}" -type f -name "*.dmg" -print -quit)"
          CLI_PATH="${TARGET_DIR}/${{ matrix.target }}/release/codex-tracker"

          if [[ -z "${APP_PATH}" || -z "${DMG_PATH}" || ! -f "${CLI_PATH}" ]]; then
            echo "Failed to locate bundle outputs."
            exit 1
          fi

          ARTIFACTS_DIR="${RUNNER_TEMP}/artifacts-${{ matrix.arch }}"
          mkdir -p "${ARTIFACTS_DIR}"

          RENAMED_DMG="${ARTIFACTS_DIR}/codex-tracker-desktop_${VERSION}_${{ matrix.arch }}.dmg"
          mv "${DMG_PATH}" "${RENAMED_DMG}"

          CLI_TAR="${ARTIFACTS_DIR}/codex-tracker_${VERSION}_${{ matrix.arch }}.tar.gz"
          tar -czf "${CLI_TAR}" -C "$(dirname "${CLI_PATH}")" "codex-tracker"

          echo "dmg=${RENAMED_DMG}" >> "${GITHUB_OUTPUT}"
          echo "app=${APP_PATH}" >> "${GITHUB_OUTPUT}"
          echo "dir=${ARTIFACTS_DIR}" >> "${GITHUB_OUTPUT}"

      - name: Package app zip
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          ZIP_PATH="${{ steps.artifacts.outputs.dir }}/codex-tracker-desktop_${VERSION}_${{ matrix.arch }}.zip"
          ditto -c -k --sequesterRsrc --keepParent "${{ steps.artifacts.outputs.app }}" "${ZIP_PATH}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ${{ runner.temp }}/artifacts-${{ matrix.arch }}/*

  release:
    runs-on: ubuntu-22.04
    needs: build-macos
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release notes
        id: notes
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          NOTES_PATH="${RUNNER_TEMP}/release-notes.md"
          awk -v ver="${VERSION}" '
            BEGIN { header = "## [" ver "]" }
            index($0, header) == 1 {print; in_section=1; next}
            in_section && index($0, "## [") == 1 {exit}
            in_section {print}
          ' CHANGELOG.md > "${NOTES_PATH}"

          if [[ ! -s "${NOTES_PATH}" ]]; then
            echo "Release ${VERSION}" > "${NOTES_PATH}"
            echo "" >> "${NOTES_PATH}"
            echo "See CHANGELOG.md for details." >> "${NOTES_PATH}"
          fi

          echo "path=${NOTES_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.dmg *.zip *.tar.gz > SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.notes.outputs.path }}
          files: |
            dist/*.dmg
            dist/*.zip
            dist/*.tar.gz
            dist/SHA256SUMS.txt
