name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked --version "^2.0.0"

      - name: Install web deps
        working-directory: apps/web
        run: npm ci

      - name: Build web
        working-directory: apps/web
        run: npm run build

      - name: Build Tauri bundles
        working-directory: apps/desktop/src-tauri
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Collect artifacts
        id: artifacts
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          TARGET_DIR="$(cargo metadata --manifest-path apps/desktop/src-tauri/Cargo.toml --format-version 1 --no-deps | python3 -c 'import json,sys; print(json.load(sys.stdin)["target_directory"])')"
          BUNDLE_DIR="${TARGET_DIR}/${{ matrix.target }}/release/bundle"
          APP_PATH="$(find "${BUNDLE_DIR}" -type d -name "*.app" -print -quit)"
          DMG_PATH="$(find "${BUNDLE_DIR}" -type f -name "*.dmg" -print -quit)"

          if [[ -z "${APP_PATH}" || -z "${DMG_PATH}" ]]; then
            echo "Failed to locate bundle outputs."
            exit 1
          fi

          ARTIFACTS_DIR="${RUNNER_TEMP}/artifacts-${{ matrix.arch }}"
          mkdir -p "${ARTIFACTS_DIR}"

          RENAMED_DMG="${ARTIFACTS_DIR}/codex-tracker_${VERSION}_${{ matrix.arch }}.dmg"
          mv "${DMG_PATH}" "${RENAMED_DMG}"

          echo "dmg=${RENAMED_DMG}" >> "${GITHUB_OUTPUT}"
          echo "app=${APP_PATH}" >> "${GITHUB_OUTPUT}"
          echo "dir=${ARTIFACTS_DIR}" >> "${GITHUB_OUTPUT}"

      - name: Package app zip
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          ZIP_PATH="${{ steps.artifacts.outputs.dir }}/codex-tracker_${VERSION}_${{ matrix.arch }}.zip"
          ditto -c -k --sequesterRsrc --keepParent "${{ steps.artifacts.outputs.app }}" "${ZIP_PATH}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ${{ runner.temp }}/artifacts-${{ matrix.arch }}/*

  release:
    runs-on: ubuntu-22.04
    needs: build-macos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release notes
        id: notes
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          NOTES_PATH="${RUNNER_TEMP}/release-notes.md"
          awk -v ver="${VERSION}" '
            BEGIN { header = "## [" ver "]" }
            index($0, header) == 1 {print; in_section=1; next}
            in_section && index($0, "## [") == 1 {exit}
            in_section {print}
          ' CHANGELOG.md > "${NOTES_PATH}"

          if [[ ! -s "${NOTES_PATH}" ]]; then
            echo "Release ${VERSION}" > "${NOTES_PATH}"
            echo "" >> "${NOTES_PATH}"
            echo "See CHANGELOG.md for details." >> "${NOTES_PATH}"
          fi

          echo "path=${NOTES_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.dmg *.zip > SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.notes.outputs.path }}
          files: |
            dist/*.dmg
            dist/*.zip
            dist/SHA256SUMS.txt
