name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            arch: arm64
          - target: x86_64-apple-darwin
            arch: x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked --version "^2.0.0"

      - name: Install web deps
        working-directory: apps/web
        run: npm ci

      - name: Build web
        working-directory: apps/web
        run: npm run build

      - name: Import Apple certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="${RUNNER_TEMP}/codex-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"
          CERT_PATH="${RUNNER_TEMP}/certificate.p12"

          echo "${APPLE_CERTIFICATE}" | base64 --decode > "${CERT_PATH}"
          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" -P "${APPLE_CERTIFICATE_PASSWORD}" -A -t cert -f pkcs12 -k "${KEYCHAIN_PATH}"
          security list-keychains -d user -s "${KEYCHAIN_PATH}"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"

      - name: Prepare notarization key
        env:
          APPLE_API_PRIVATE_KEY: ${{ secrets.APPLE_API_PRIVATE_KEY }}
        run: |
          if [[ -n "${APPLE_API_PRIVATE_KEY}" ]]; then
            echo "${APPLE_API_PRIVATE_KEY}" | base64 --decode > "${RUNNER_TEMP}/AuthKey.p8"
          fi

      - name: Build Tauri bundles
        working-directory: apps/desktop/src-tauri
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Collect artifacts
        id: artifacts
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          BUNDLE_DIR="apps/desktop/src-tauri/target/${{ matrix.target }}/release/bundle"
          APP_PATH="$(find "${BUNDLE_DIR}" -type d -name "*.app" -print -quit)"
          DMG_PATH="$(find "${BUNDLE_DIR}" -type f -name "*.dmg" -print -quit)"

          if [[ -z "${APP_PATH}" || -z "${DMG_PATH}" ]]; then
            echo "Failed to locate bundle outputs."
            exit 1
          fi

          ARTIFACTS_DIR="${RUNNER_TEMP}/artifacts-${{ matrix.arch }}"
          mkdir -p "${ARTIFACTS_DIR}"

          RENAMED_DMG="${ARTIFACTS_DIR}/codex-tracker_${VERSION}_${{ matrix.arch }}.dmg"
          mv "${DMG_PATH}" "${RENAMED_DMG}"

          echo "dmg=${RENAMED_DMG}" >> "${GITHUB_OUTPUT}"
          echo "app=${APP_PATH}" >> "${GITHUB_OUTPUT}"
          echo "dir=${ARTIFACTS_DIR}" >> "${GITHUB_OUTPUT}"

      - name: Notarize DMG
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG_PATH="${{ steps.artifacts.outputs.dmg }}"
          if [[ -f "${RUNNER_TEMP}/AuthKey.p8" ]]; then
            xcrun notarytool submit "${DMG_PATH}" \
              --key "${RUNNER_TEMP}/AuthKey.p8" \
              --key-id "${APPLE_API_KEY_ID}" \
              --issuer "${APPLE_API_ISSUER_ID}" \
              --wait
          elif [[ -n "${APPLE_ID}" && -n "${APPLE_APP_SPECIFIC_PASSWORD}" ]]; then
            xcrun notarytool submit "${DMG_PATH}" \
              --apple-id "${APPLE_ID}" \
              --password "${APPLE_APP_SPECIFIC_PASSWORD}" \
              --team-id "${APPLE_TEAM_ID}" \
              --wait
          else
            echo "Missing notarization credentials."
            exit 1
          fi

      - name: Staple notarization
        run: |
          xcrun stapler staple "${{ steps.artifacts.outputs.app }}"
          xcrun stapler staple "${{ steps.artifacts.outputs.dmg }}"

      - name: Package app zip
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          ZIP_PATH="${{ steps.artifacts.outputs.dir }}/codex-tracker_${VERSION}_${{ matrix.arch }}.zip"
          ditto -c -k --sequesterRsrc --keepParent "${{ steps.artifacts.outputs.app }}" "${ZIP_PATH}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ${{ runner.temp }}/artifacts-${{ matrix.arch }}/*

  release:
    runs-on: ubuntu-22.04
    needs: build-macos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate release notes
        id: notes
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          NOTES_PATH="${RUNNER_TEMP}/release-notes.md"
          awk -v ver="${VERSION}" '
            $0 ~ "^## \\[" ver "\\]" {print; in_section=1; next}
            in_section && /^## \\[/ {exit}
            in_section {print}
          ' CHANGELOG.md > "${NOTES_PATH}"

          if [[ ! -s "${NOTES_PATH}" ]]; then
            echo "Release ${VERSION}" > "${NOTES_PATH}"
            echo "" >> "${NOTES_PATH}"
            echo "See CHANGELOG.md for details." >> "${NOTES_PATH}"
          fi

          echo "path=${NOTES_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.dmg *.zip > SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.notes.outputs.path }}
          files: |
            dist/*.dmg
            dist/*.zip
            dist/SHA256SUMS.txt
